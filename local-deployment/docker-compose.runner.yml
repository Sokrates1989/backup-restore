# Docker Compose for the backup runner service
# This runs alongside the main app to periodically execute due backup schedules
#
# Usage:
#   docker compose --env-file ../.env -f docker-compose.postgres.yml -f docker-compose.runner.yml up
#
# IMPORTANT:
# Set a unique Compose project name per repo.
name: backup-restore-private

services:
  runner:
    build:
      context: ..
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: ${PYTHON_VERSION}-slim
        IMAGE_TAG: ${IMAGE_TAG:-dev}
    develop:
      watch:
        - action: sync+restart
          path: ../app
          target: /app
    command: ["python", "runner.py"]
    env_file:
      - ../.env
    environment:
      # Runner configuration
      RUNNER_MODE: ${RUNNER_MODE:-direct}
      RUNNER_INTERVAL: ${RUNNER_INTERVAL:-60}
      RUNNER_MAX_SCHEDULES: ${RUNNER_MAX_SCHEDULES:-10}
      BACKUP_API_URL: http://app:8000
      KEYCLOAK_URL: ${KEYCLOAK_URL:-http://localhost:9090}
      KEYCLOAK_INTERNAL_URL: ${KEYCLOAK_INTERNAL_URL:-http://keycloak:9090}
      KEYCLOAK_REALM: ${KEYCLOAK_REALM:-backup-restore}
      KEYCLOAK_CLIENT_ID: ${KEYCLOAK_CLIENT_ID:-backup-restore-backend}
      KEYCLOAK_CLIENT_SECRET: ${KEYCLOAK_CLIENT_SECRET:-}
    depends_on:
      app:
        condition: service_healthy
    restart: unless-stopped
